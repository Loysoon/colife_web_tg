<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Настройки фильтров</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #1f2328);
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      .card {
        background: var(--tg-theme-secondary-bg-color, #f7f8fa);
        border: 1px solid var(--tg-theme-hint-color, #e5e7eb);
        border-radius: 12px;
        padding: 16px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 12px;
      }
      .section { margin-top: 16px; }
      .section h2 {
        font-size: 15px;
        margin: 0 0 8px;
        color: var(--tg-theme-hint-color, #6b7280);
        font-weight: 600;
      }
      .group { display: grid; gap: 8px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .chip {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 8px 12px; border: 1px solid var(--tg-theme-hint-color, #e5e7eb); border-radius: 10px;
        background: var(--tg-theme-bg-color, #ffffff);
      }
      input[type="number"], select, input[type="text"] {
        background: var(--tg-theme-bg-color, #ffffff);
        border: 1px solid var(--tg-theme-hint-color, #e5e7eb);
        color: var(--tg-theme-text-color, #1f2328);
        border-radius: 8px;
        padding: 10px 12px;
        width: 100%;
      }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .grid-2, .grid-3 { width: 100%; }
      .actions { display: flex; gap: 10px; margin-top: 20px; }
      button {
        appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer;
        font-weight: 600;
      }
      .btn-primary { background: var(--tg-theme-button-color, #1f6feb); color: var(--tg-theme-button-text-color, #ffffff); }
      .btn-secondary { background: transparent; color: var(--tg-theme-text-color, #1f2328); border: 1px solid var(--tg-theme-hint-color, #e5e7eb); }
      label { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
      .checkboxes { display: grid; gap: 8px; }
      .scroll {
        max-height: 200px; overflow: auto; border: 1px solid var(--tg-theme-hint-color, #e5e7eb); border-radius: 10px; padding: 8px;
        background: var(--tg-theme-bg-color, #ffffff);
      }
      /* Подсветка ошибок */
      .input-error {
        border-color: #e74c3c !important;
        background: rgba(231, 76, 60, 0.08) !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>Настройки фильтров</h1>

        <div class="section">
          <h2>Тип жилья</h2>
          <div class="group">
            <label class="chip"><input type="radio" name="type" value="any" checked /> Любое</label>
            <div class="row">
              <label class="chip"><input type="radio" name="type" value="flat" /> Квартира</label>
              <label class="chip"><input type="radio" name="type" value="room" /> Комната</label>
              <label class="chip"><input type="radio" name="type" value="unit" /> Номер</label>
              <label class="chip"><input type="radio" name="type" value="flat1" /> Однокомнатная квартира</label>
              <label class="chip"><input type="radio" name="type" value="bed" /> Спальное место</label>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Цена, ₽</h2>
          <div class="grid-2">
            <input type="number" id="price_min" placeholder="От" min="1" step="1" />
            <input type="number" id="price_max" placeholder="До" min="1" step="1" />
          </div>
        </div>

        <div class="section">
          <h2>Удаленность от кольцевой линии</h2>
          <div class="row">
            <label class="chip"><input type="checkbox" name="ring" value="1" /> 1</label>
            <label class="chip"><input type="checkbox" name="ring" value="2" /> 2</label>
            <label class="chip"><input type="checkbox" name="ring" value="3" /> 3</label>
            <label class="chip"><input type="checkbox" name="ring" value="4" /> 4</label>
            <label class="chip"><input type="checkbox" name="ring" value="6" /> 6</label>
            <label class="chip"><input type="checkbox" name="ring" value="inside" /> Внутри кольца</label>
          </div>
        </div>

        <div class="section">
          <h2>Линия метро</h2>
          <div class="scroll checkboxes">
            <label><input type="checkbox" value="arbatsko_pokrovskaya" /> Арбатско-Покровская (Синяя)</label>
            <label><input type="checkbox" value="bolshaya_koltsevaya" /> Большая кольцевая (Бирюзовая)</label>
            <label><input type="checkbox" value="zamoskvoretskaya" /> Замоскворецкая (Зеленая)</label>
            <label><input type="checkbox" value="koltsevaya" /> Кольцевая</label>
            <label><input type="checkbox" value="lyublinsko_dmitrovskaya" /> Люблинско-Дмитровская (Салатовая)</label>
            <label><input type="checkbox" value="mcc" /> МЦК</label>
            <label><input type="checkbox" value="sokolnicheskaya" /> Сокольническая (Красная)</label>
            <label><input type="checkbox" value="tagansko_krasnopresnenskaya" /> Таганско-Краснопресненская (Сиреневая)</label>
            <label><input type="checkbox" value="filevskaya" /> Филевская (Голубая)</label>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" id="saveBtn">Сохранить</button>
          <button class="btn-secondary" id="resetBtn">Сбросить</button>
        </div>
      </div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      document.getElementById('resetBtn').addEventListener('click', () => {
        document.querySelector('input[name="type"][value="any"]').checked = true;
        document.getElementById('price_min').value = '';
        document.getElementById('price_max').value = '';
        document.querySelectorAll('input[name="ring"]').forEach(i => i.checked = false);
        document.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
      });

      document.getElementById('saveBtn').addEventListener('click', () => {
        // Блокируем сохранение при логической ошибке цены
        if (!isPriceRangeValid()) {
          alert('Проверьте поля цены: "До" не может быть меньше "От"');
          return;
        }
        // Заглушка: просто уведомление и вывод в консоль
        const payload = collectPayload();
        console.log('Filters payload:', payload);
        alert('Фильтры сохранены (заглушка).');
        if (tg) {
          tg.close();
        }
      });

      // Валидация цен: запрещаем 0/отрицательные и подсвечиваем логическую ошибку (от > до)
      const priceMinEl = document.getElementById('price_min');
      const priceMaxEl = document.getElementById('price_max');

      function clampPositive(el) {
        const v = parseInt(el.value, 10);
        if (isNaN(v) || v <= 0) {
          el.classList.add('input-error');
        } else {
          el.classList.remove('input-error');
        }
      }

      function validateRange() {
        const vMin = parseInt(priceMinEl.value, 10);
        const vMax = parseInt(priceMaxEl.value, 10);
        // убираем прошлую подсветку
        priceMinEl.classList.remove('input-error');
        priceMaxEl.classList.remove('input-error');
        // если введены оба и логика нарушена — подсветить оба
        if (!isNaN(vMin) && !isNaN(vMax) && vMax < vMin) {
          priceMinEl.classList.add('input-error');
          priceMaxEl.classList.add('input-error');
        }
      }

      function isPriceRangeValid() {
        const vMin = parseInt(priceMinEl.value, 10);
        const vMax = parseInt(priceMaxEl.value, 10);
        // Пустые поля считаем валидными (нет фильтра) — проверяем только если оба заданы
        if (isNaN(vMin) && isNaN(vMax)) return true;
        if (!isNaN(vMin) && vMin <= 0) return false;
        if (!isNaN(vMax) && vMax <= 0) return false;
        if (!isNaN(vMin) && !isNaN(vMax) && vMax < vMin) return false;
        return true;
      }

      function cleanupOnBlur(el) {
        const v = parseInt(el.value, 10);
        if (isNaN(v) || v <= 0) {
          el.value = '';
          el.classList.remove('input-error');
        }
      }

      priceMinEl.addEventListener('input', () => { clampPositive(priceMinEl); validateRange(); });
      priceMaxEl.addEventListener('input', () => { clampPositive(priceMaxEl); validateRange(); });
      priceMinEl.addEventListener('blur', () => { cleanupOnBlur(priceMinEl); validateRange(); });
      priceMaxEl.addEventListener('blur', () => { cleanupOnBlur(priceMaxEl); validateRange(); });

      function collectPayload() {
        const type = document.querySelector('input[name="type"]:checked')?.value || 'any';
        const price_min = Number(document.getElementById('price_min').value || 0);
        const price_max = Number(document.getElementById('price_max').value || 0);
        const rings = Array.from(document.querySelectorAll('input[name="ring"]:checked')).map(i => i.value);
        const metros = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.value);
        return { type, price_min, price_max, rings, metros };
      }
    </script>
  </body>
  </html>


