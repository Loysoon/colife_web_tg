<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Настройки фильтров</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #1f2328);
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      .card {
        background: var(--tg-theme-secondary-bg-color, #f7f8fa);
        border: 1px solid var(--tg-theme-hint-color, #e5e7eb);
        border-radius: 12px;
        padding: 16px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 12px;
      }
      .section { margin-top: 16px; }
      .section h2 {
        font-size: 15px;
        margin: 0 0 8px;
        color: var(--tg-theme-hint-color, #6b7280);
        font-weight: 600;
      }
      .group { display: grid; gap: 8px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .chip {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 8px 12px; border: 1px solid var(--tg-theme-hint-color, #e5e7eb); border-radius: 10px;
        background: var(--tg-theme-bg-color, #ffffff);
      }
      input[type="number"], select, input[type="text"] {
        background: var(--tg-theme-bg-color, #ffffff);
        border: 1px solid var(--tg-theme-hint-color, #e5e7eb);
        color: var(--tg-theme-text-color, #1f2328);
        border-radius: 8px;
        padding: 10px 12px;
        width: 100%;
      }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .grid-2, .grid-3 { width: 100%; }
      .actions { display: flex; gap: 10px; margin-top: 20px; }
      button {
        appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer;
        font-weight: 600;
      }
      .btn-primary { background: var(--tg-theme-button-color, #1f6feb); color: var(--tg-theme-button-text-color, #ffffff); }
      .btn-secondary { background: transparent; color: var(--tg-theme-text-color, #1f2328); border: 1px solid var(--tg-theme-hint-color, #e5e7eb); }
      label { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
      .checkboxes { display: grid; gap: 8px; }
      .scroll {
        max-height: 200px; overflow: auto; border: 1px solid var(--tg-theme-hint-color, #e5e7eb); border-radius: 10px; padding: 8px;
        background: var(--tg-theme-bg-color, #ffffff);
      }
      /* Подсветка ошибок */
      .input-error {
        border-color: #e74c3c !important;
        background: rgba(231, 76, 60, 0.08) !important;
      }
      .metro-icon { width: 18px; height: 18px; object-fit: contain; vertical-align: middle; margin-right: 6px; }
      /* Диапазон цены: один слайдер, два бегунка, активная заливка между ними */
      .range-slider { position: relative; height: 44px; }
      .range-slider input[type="range"] {
        -webkit-appearance: none; appearance: none;
        position: absolute; left: 0; right: 0; width: 100%;
        top: 50%; transform: translateY(-50%);
        height: 6px; margin: 0; background: transparent; pointer-events: none;
      }
      /* прячем стандартные треки */
      .range-slider input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: transparent; border: 0; }
      .range-slider input[type="range"]::-moz-range-track { height: 6px; background: transparent; border: 0; }
      /* стили бегунков */
      .range-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; pointer-events: all;
        position: relative; z-index: 3; width: 16px; height: 16px; border-radius: 50%;
        background: var(--tg-theme-button-color, #1f6feb); border: 2px solid #ffffff; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        margin-top: -5px; /* центрируем на треке 6px */
      }
      .range-slider input[type="range"]::-moz-range-thumb {
        pointer-events: all; position: relative; z-index: 3; width: 16px; height: 16px; border-radius: 50%;
        background: var(--tg-theme-button-color, #1f6feb); border: 2px solid #ffffff; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        margin-top: -5px;
      }
      .range-slider #price_min_range { z-index: 4; }
      .range-slider #price_max_range { z-index: 3; }
      .range-track { position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%); height: 6px; background: var(--tg-theme-hint-color, #e5e7eb); border-radius: 999px; z-index: 1; }
      .range-active { position: absolute; height: 100%; background: var(--tg-theme-button-color, #1f6feb); border-radius: 999px; z-index: 2; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>Настройки фильтров</h1>

        <div class="section">
          <h2>Тип жилья</h2>
          <div class="group">
            <div class="row">
              <label class="chip"><input type="checkbox" id="type_any" /> Любое</label>
              <label class="chip"><input type="checkbox" name="type_multi" value="Квартира" /> Квартира</label>
              <label class="chip"><input type="checkbox" name="type_multi" value="Комната" /> Комната</label>
              <label class="chip"><input type="checkbox" name="type_multi" value="Номер" /> Номер</label>
              <label class="chip"><input type="checkbox" name="type_multi" value="Однокомнатная квартира" /> Однокомнатная квартира</label>
              <label class="chip"><input type="checkbox" name="type_multi" value="Спальное место" /> Спальное место</label>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Цена, ₽</h2>
          <div class="group">
            <div class="row">
              <span>От: <strong id="price_min_value">—</strong></span>
              <span>До: <strong id="price_max_value">—</strong></span>
            </div>
            <div class="range-slider">
              <div class="range-track"><div class="range-active" id="price_range_active"></div></div>
              <input type="range" id="price_min_range" min="10000" max="200000" step="1000" />
              <input type="range" id="price_max_range" min="10000" max="200000" step="1000" />
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Удаленность от кольцевой линии</h2>
          <div class="row">
            <label class="chip"><input type="checkbox" id="ring_any" /> Любое</label>
            <label class="chip"><input type="checkbox" name="ring" value="1" /> 1</label>
            <label class="chip"><input type="checkbox" name="ring" value="2" /> 2</label>
            <label class="chip"><input type="checkbox" name="ring" value="3" /> 3</label>
            <label class="chip"><input type="checkbox" name="ring" value="4" /> 4</label>
            <label class="chip"><input type="checkbox" name="ring" value="5" /> 5</label>
            <label class="chip"><input type="checkbox" name="ring" value="6" /> 6</label>
            <label class="chip"><input type="checkbox" name="ring" value="7" /> 7</label>
            <label class="chip"><input type="checkbox" name="ring" value="8" /> 8</label>
            <label class="chip"><input type="checkbox" name="ring" value="9" /> 9</label>
            <label class="chip"><input type="checkbox" name="ring" value="10" /> 10</label>
            <label class="chip"><input type="checkbox" name="ring" value="11" /> 11</label>
            <label class="chip"><input type="checkbox" name="ring" value="12" /> 12</label>
            <label class="chip"><input type="checkbox" name="ring" value="13" /> 13</label>
            <label class="chip"><input type="checkbox" name="ring" value="14" /> 14</label>
            <label class="chip"><input type="checkbox" name="ring" value="15" /> 15</label>
            <label class="chip"><input type="checkbox" name="ring" value="inside" /> Внутри кольца</label>
          </div>
        </div>

        <div class="section">
          <h2>Линия метро</h2>
          <div class="scroll checkboxes">
            <label><input type="checkbox" value="Сокольническая" /> <img class="metro-icon" src="metro_icons/sokolnicheskaya.png" alt="">Сокольническая</label>
            <label><input type="checkbox" value="Замоскворецкая" /> <img class="metro-icon" src="metro_icons/zamoskvoretskaya.png" alt="">Замоскворецкая</label>
            <label><input type="checkbox" value="Арбатско-Покровская" /> <img class="metro-icon" src="metro_icons/arbatsko-pokrovskaya.png" alt="">Арбатско-Покровская</label>
            <label><input type="checkbox" value="Филёвская" /> <img class="metro-icon" src="metro_icons/filevskaya.png" alt="">Филёвская</label>
            <label><input type="checkbox" value="Кольцевая" /> <img class="metro-icon" src="metro_icons/kolcevaya.png" alt="">Кольцевая</label>
            <label><input type="checkbox" value="Калужско-Рижская" /> <img class="metro-icon" src="metro_icons/kaluzhsko-rizhskaya.png" alt="">Калужско-Рижская</label>
            <label><input type="checkbox" value="Таганско-Краснопресненская" /> <img class="metro-icon" src="metro_icons/tagansko-krasnopresnenskaya.png" alt="">Таганско-Краснопресненская</label>
            <label><input type="checkbox" value="Калининская" /> <img class="metro-icon" src="metro_icons/kalininskaya.png" alt="">Калининская</label>
            <label><input type="checkbox" value="Солнцевская" /> <img class="metro-icon" src="metro_icons/solncevskaya.png" alt="">Солнцевская</label>
            <label><input type="checkbox" value="Серпуховско-Тимирязевская" /> <img class="metro-icon" src="metro_icons/serpuhovsko-timiryazevskaya.png" alt="">Серпуховско-Тимирязевская</label>
            <label><input type="checkbox" value="Люблинско-Дмитровская" /> <img class="metro-icon" src="metro_icons/lyublinsko-dmitrovskaya.png" alt="">Люблинско-Дмитровская</label>
            <label><input type="checkbox" value="Большая кольцевая" /> <img class="metro-icon" src="metro_icons/bolshaya-kolcevaya.png" alt="">Большая кольцевая</label>
            <label><input type="checkbox" value="Бутовская" /> <img class="metro-icon" src="metro_icons/butovskaya.png" alt="">Бутовская</label>
            <label><input type="checkbox" value="Московское центральное кольцо" /> <img class="metro-icon" src="metro_icons/mck.png" alt="">Московское центральное кольцо</label>
            <label><input type="checkbox" value="Некрасовская" /> <img class="metro-icon" src="metro_icons/nekrasovskaya.png" alt="">Некрасовская</label>
            <label><input type="checkbox" value="Троицкая" /> <img class="metro-icon" src="metro_icons/troickaya.png" alt="">Троицкая</label>
            <label><input type="checkbox" value="Рублёво-Архангельская" /> <img class="metro-icon" src="metro_icons/rublovo-arhangelskaya.png" alt="">Рублёво-Архангельская</label>
            <label><input type="checkbox" value="Бирюлёвская" /> <img class="metro-icon" src="metro_icons/biryulevskaya.png" alt="">Бирюлёвская</label>
            <label><input type="checkbox" value="МЦД1" /> <img class="metro-icon" src="metro_icons/mcd1.png" alt="">МЦД1</label>
            <label><input type="checkbox" value="МЦД2" /> <img class="metro-icon" src="metro_icons/mcd2.png" alt="">МЦД2</label>
            <label><input type="checkbox" value="МЦД3" /> <img class="metro-icon" src="metro_icons/mcd3.png" alt="">МЦД3</label>
            <label><input type="checkbox" value="МЦД4" /> <img class="metro-icon" src="metro_icons/mcd4.png" alt="">МЦД4</label>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" id="saveBtn">Сохранить</button>
          <button class="btn-secondary" id="resetBtn">Сбросить</button>
        </div>
      </div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      document.getElementById('resetBtn').addEventListener('click', () => {
        // Тип жилья — вернуть "Любое"
        const typeAnyEl = document.getElementById('type_any');
        if (typeAnyEl) typeAnyEl.checked = true;
        document.querySelectorAll('input[name="type_multi"]').forEach(i => i.checked = false);

        // Удалённость — вернуть "Любое"
        const ringAnyEl = document.getElementById('ring_any');
        if (ringAnyEl) ringAnyEl.checked = true;
        document.querySelectorAll('input[name="ring"]').forEach(i => i.checked = false);

        // Метро — очистить
        document.querySelectorAll('.checkboxes input[type="checkbox"]').forEach(i => i.checked = false);

        // Цена — вернуть к дефолту
        setPriceRanges(DEFAULT_MIN_PRICE, DEFAULT_MAX_PRICE);
      });

      document.getElementById('saveBtn').addEventListener('click', () => {
        // Блокируем сохранение при логической ошибке цены
        if (!isPriceRangeValid()) {
          alert('Проверьте поля цены: "До" не может быть меньше "От"');
          return;
        }
        const payload = collectPayload();
        console.log('Filters payload:', payload);
        try {
          if (tg?.sendData) {
            tg.sendData(JSON.stringify(payload));
          }
        } catch (e) {
          console.error('sendData error', e);
        }
        if (tg) tg.close();
      });

      // Диапазон цены: двойной бегунок на одной полосе
      const DEFAULT_MIN_PRICE = 10000;
      const DEFAULT_MAX_PRICE = 200000;
      const minRangeEl = document.getElementById('price_min_range');
      const maxRangeEl = document.getElementById('price_max_range');
      const minValueEl = document.getElementById('price_min_value');
      const maxValueEl = document.getElementById('price_max_value');
      const activeTrackEl = document.getElementById('price_range_active');

      function formatPrice(v) { return Number(v).toLocaleString('ru-RU'); }

      function setPriceRanges(minV, maxV) {
        const minAttr = parseInt(minRangeEl.min, 10);
        const maxAttr = parseInt(minRangeEl.max, 10);
        const step = parseInt(minRangeEl.step, 10) || 1;
        minV = Math.max(minAttr, Math.min(maxAttr, Math.round(minV / step) * step));
        maxV = Math.max(minAttr, Math.min(maxAttr, Math.round(maxV / step) * step));
        if (minV > maxV) [minV, maxV] = [maxV, minV];
        minRangeEl.value = String(minV);
        maxRangeEl.value = String(maxV);
        updateRangeUI();
      }

      function updateRangeUI() {
        const min = parseInt(minRangeEl.value, 10);
        const max = parseInt(maxRangeEl.value, 10);
        minValueEl.textContent = formatPrice(min);
        maxValueEl.textContent = formatPrice(max);
        const minAttr = parseInt(minRangeEl.min, 10);
        const maxAttr = parseInt(minRangeEl.max, 10);
        const total = maxAttr - minAttr;
        const leftPct = ((min - minAttr) / total) * 100;
        const rightPct = ((max - minAttr) / total) * 100;
        activeTrackEl.style.left = leftPct + '%';
        activeTrackEl.style.width = (rightPct - leftPct) + '%';
      }

      function isPriceRangeValid() {
        const vMin = parseInt(minRangeEl.value, 10);
        const vMax = parseInt(maxRangeEl.value, 10);
        return vMax >= vMin;
      }

      minRangeEl.addEventListener('input', () => {
        const min = parseInt(minRangeEl.value, 10);
        const max = parseInt(maxRangeEl.value, 10);
        if (min > max) { maxRangeEl.value = String(min); }
        updateRangeUI();
      });
      maxRangeEl.addEventListener('input', () => {
        const min = parseInt(minRangeEl.value, 10);
        const max = parseInt(maxRangeEl.value, 10);
        if (max < min) { minRangeEl.value = String(max); }
        updateRangeUI();
      });

      // инициализация
      setPriceRanges(DEFAULT_MIN_PRICE, DEFAULT_MAX_PRICE);

      // Применение фильтров, переданных через ?filters=
      function applyFiltersFromUrl() {
        try {
          const params = new URLSearchParams(window.location.search);
          const raw = params.get('filters');
          if (!raw) return;

          let data;
          try {
            data = JSON.parse(decodeURIComponent(raw));
          } catch (_) {
            return;
          }

          // Тип жилья: поддержка старого поля type и множественного выбора
          const typeAnyEl = document.getElementById('type_any');
          const selectedTypes = Array.isArray(data.types) ? data.types.map(String) : [];
          if (selectedTypes.length) {
            const set = new Set(selectedTypes);
            document.querySelectorAll('input[name="type_multi"]').forEach(i => i.checked = set.has(i.value));
            if (typeAnyEl) typeAnyEl.checked = false;
          } else if (typeof data.type === 'string') {
            if (data.type === 'Любое') {
              if (typeAnyEl) typeAnyEl.checked = true;
            } else {
              document.querySelectorAll('input[name="type_multi"]').forEach(i => i.checked = (i.value === data.type));
              if (typeAnyEl) typeAnyEl.checked = false;
            }
          } else {
            if (typeAnyEl) typeAnyEl.checked = true;
          }

          // Цена — восстановим положения бегунков
          let minV = DEFAULT_MIN_PRICE;
          let maxV = DEFAULT_MAX_PRICE;
          if (typeof data.price_min === 'number' && data.price_min > 0) minV = data.price_min;
          if (typeof data.price_max === 'number' && data.price_max > 0) maxV = data.price_max;
          setPriceRanges(minV, maxV);

          // Удаленность от кольцевой: если пусто — считаем Любое
          const ringAnyEl = document.getElementById('ring_any');
          if (Array.isArray(data.rings) && data.rings.length) {
            const normalized = new Set(data.rings.map(v => (v === 'Внутри кольца' ? 'inside' : String(v))));
            document.querySelectorAll('input[name="ring"]').forEach(i => {
              i.checked = normalized.has(i.value);
            });
            if (ringAnyEl) ringAnyEl.checked = false;
          } else {
            if (ringAnyEl) ringAnyEl.checked = true;
            document.querySelectorAll('input[name="ring"]').forEach(i => i.checked = false);
          }

          // Линии метро
          if (Array.isArray(data.metros) && data.metros.length) {
            const metrosSet = new Set(data.metros.map(String));
            document.querySelectorAll('.checkboxes input[type="checkbox"]').forEach(i => {
              i.checked = metrosSet.has(i.value);
            });
          }
        } catch (e) {
          console.error('applyFiltersFromUrl error', e);
        }
      }

      function collectPayload() {
        const payload = {};
        // Тип жилья: возвращаем либо 'type: Любое', либо одиночный type, либо массив types
        const typeAnyEl = document.getElementById('type_any');
        const types = Array.from(document.querySelectorAll('input[name="type_multi"]:checked')).map(i => i.value);
        if (typeAnyEl && typeAnyEl.checked) {
          payload.type = 'Любое';
        } else if (types.length === 1) {
          payload.type = types[0];
        } else if (types.length > 1) {
          payload.types = types;
        } else {
          payload.type = 'Любое';
        }

        const vMin = parseInt(minRangeEl.value, 10);
        const vMax = parseInt(maxRangeEl.value, 10);
        if (!isNaN(vMin) && vMin > 0) payload.price_min = vMin;
        if (!isNaN(vMax) && vMax > 0) payload.price_max = vMax;

        const ringAnyEl = document.getElementById('ring_any');
        if (!(ringAnyEl && ringAnyEl.checked)) {
          const rings = Array.from(document.querySelectorAll('input[name="ring"]:checked')).map(i => {
            if (i.value === 'inside') return 'Внутри кольца';
            const n = parseInt(i.value, 10);
            return isNaN(n) ? i.value : n;
          });
          if (rings.length) payload.rings = rings;
        }

        // Метро: только чекбоксы внутри блока со списком метро
        const metros = Array.from(document.querySelectorAll('.checkboxes input[type="checkbox"]:checked')).map(i => i.value);
        if (metros.length) payload.metros = metros;

        return payload;
      }

      // Применить фильтры из URL при загрузке
      applyFiltersFromUrl();

      // Логика: "Любое" для удаленности ↔ конкретные значения
      (function bindRingAnyLogic(){
        const ringAnyEl = document.getElementById('ring_any');
        if (!ringAnyEl) return;
        // начальное состояние: если ничего не выбрано — "Любое"
        ringAnyEl.checked = Array.from(document.querySelectorAll('input[name="ring"]:checked')).length === 0;
        ringAnyEl.addEventListener('change', () => {
          if (ringAnyEl.checked) {
            // Включили «Любое» — снимаем конкретные значения
            document.querySelectorAll('input[name="ring"]').forEach(i => i.checked = false);
          } else {
            // Пользователь попытался снять «Любое». Если ничего другого не выбрано — не даём снять
            const anyChecked = Array.from(document.querySelectorAll('input[name="ring"]:checked')).length > 0;
            if (!anyChecked) ringAnyEl.checked = true;
          }
        });
        document.querySelectorAll('input[name="ring"]').forEach(i => {
          i.addEventListener('change', () => {
            const anyChecked = Array.from(document.querySelectorAll('input[name=\"ring\"]:checked')).length > 0;
            ringAnyEl.checked = !anyChecked;
          });
        });
      })();

      // Логика: "Любое" для типа жилья ↔ конкретные значения
      (function bindTypeAnyLogic(){
        const typeAnyEl = document.getElementById('type_any');
        if (!typeAnyEl) return;
        // начальное состояние: если ничего не выбрано — "Любое"
        typeAnyEl.checked = Array.from(document.querySelectorAll('input[name="type_multi"]:checked')).length === 0;
        typeAnyEl.addEventListener('change', () => {
          if (typeAnyEl.checked) {
            document.querySelectorAll('input[name="type_multi"]').forEach(i => i.checked = false);
          } else {
            const anyChecked = Array.from(document.querySelectorAll('input[name="type_multi"]:checked')).length > 0;
            if (!anyChecked) typeAnyEl.checked = true;
          }
        });
        document.querySelectorAll('input[name="type_multi"]').forEach(i => {
          i.addEventListener('change', () => {
            const anyChecked = Array.from(document.querySelectorAll('input[name=\"type_multi\"]:checked')).length > 0;
            typeAnyEl.checked = !anyChecked;
          });
        });
      })();
    </script>
  </body>
  </html>


