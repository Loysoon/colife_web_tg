<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Настройки фильтров</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #1f2328);
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      .card {
        background: var(--tg-theme-secondary-bg-color, #f7f8fa);
        border: 1px solid var(--tg-theme-hint-color, #e5e7eb);
        border-radius: 12px;
        padding: 16px;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 12px;
      }
      .section { margin-top: 16px; }
      .section h2 {
        font-size: 15px;
        margin: 0 0 8px;
        color: var(--tg-theme-hint-color, #6b7280);
        font-weight: 600;
      }
      .group { display: grid; gap: 8px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .chip {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 8px 12px; border: 1px solid var(--tg-theme-hint-color, #e5e7eb); border-radius: 10px;
        background: var(--tg-theme-bg-color, #ffffff);
      }
      input[type="number"], select, input[type="text"] {
        background: var(--tg-theme-bg-color, #ffffff);
        border: 1px solid var(--tg-theme-hint-color, #e5e7eb);
        color: var(--tg-theme-text-color, #1f2328);
        border-radius: 8px;
        padding: 10px 12px;
        width: 100%;
      }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
      .grid-2, .grid-3 { width: 100%; }
      .actions { display: flex; gap: 10px; margin-top: 20px; }
      button {
        appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer;
        font-weight: 600;
      }
      .btn-primary { background: var(--tg-theme-button-color, #1f6feb); color: var(--tg-theme-button-text-color, #ffffff); }
      .btn-secondary { background: transparent; color: var(--tg-theme-text-color, #1f2328); border: 1px solid var(--tg-theme-hint-color, #e5e7eb); }
      label { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
      .checkboxes { display: grid; gap: 8px; }
      .scroll {
        max-height: 200px; overflow: auto; border: 1px solid var(--tg-theme-hint-color, #e5e7eb); border-radius: 10px; padding: 8px;
        background: var(--tg-theme-bg-color, #ffffff);
      }
      /* Подсветка ошибок */
      .input-error {
        border-color: #e74c3c !important;
        background: rgba(231, 76, 60, 0.08) !important;
      }
      .metro-icon { width: 18px; height: 18px; object-fit: contain; vertical-align: middle; margin-right: 6px; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>Настройки фильтров</h1>

        <div class="section">
          <h2>Тип жилья</h2>
          <div class="group">
            <label class="chip"><input type="radio" name="type" value="Любое" checked /> Любое</label>
            <div class="row">
              <label class="chip"><input type="radio" name="type" value="Квартира" /> Квартира</label>
              <label class="chip"><input type="radio" name="type" value="Комната" /> Комната</label>
              <label class="chip"><input type="radio" name="type" value="Номер" /> Номер</label>
              <label class="chip"><input type="radio" name="type" value="Однокомнатная квартира" /> Однокомнатная квартира</label>
              <label class="chip"><input type="radio" name="type" value="Спальное место" /> Спальное место</label>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Цена, ₽</h2>
          <div class="grid-2">
            <input type="number" id="price_min" placeholder="От" min="1" step="1" />
            <input type="number" id="price_max" placeholder="До" min="1" step="1" />
          </div>
        </div>

        <div class="section">
          <h2>Удаленность от кольцевой линии</h2>
          <div class="row">
            <label class="chip"><input type="checkbox" name="ring" value="1" /> 1</label>
            <label class="chip"><input type="checkbox" name="ring" value="2" /> 2</label>
            <label class="chip"><input type="checkbox" name="ring" value="3" /> 3</label>
            <label class="chip"><input type="checkbox" name="ring" value="4" /> 4</label>
            <label class="chip"><input type="checkbox" name="ring" value="6" /> 6</label>
            <label class="chip"><input type="checkbox" name="ring" value="inside" /> Внутри кольца</label>
          </div>
        </div>

        <div class="section">
          <h2>Линия метро</h2>
          <div class="scroll checkboxes">
            <label><input type="checkbox" value="Сокольническая" /> <img class="metro-icon" src="metro_icons/sokolnicheskaya.png" alt="">Сокольническая</label>
            <label><input type="checkbox" value="Замоскворецкая" /> <img class="metro-icon" src="metro_icons/zamoskvoretskaya.png" alt="">Замоскворецкая</label>
            <label><input type="checkbox" value="Арбатско-Покровская" /> <img class="metro-icon" src="metro_icons/arbatsko-pokrovskaya.png" alt="">Арбатско-Покровская</label>
            <label><input type="checkbox" value="Филёвская" /> <img class="metro-icon" src="metro_icons/filevskaya.png" alt="">Филёвская</label>
            <label><input type="checkbox" value="Кольцевая" /> <img class="metro-icon" src="metro_icons/kolcevaya.png" alt="">Кольцевая</label>
            <label><input type="checkbox" value="Калужско-Рижская" /> <img class="metro-icon" src="metro_icons/kaluzhsko-rizhskaya.png" alt="">Калужско-Рижская</label>
            <label><input type="checkbox" value="Таганско-Краснопресненская" /> <img class="metro-icon" src="metro_icons/tagansko-krasnopresnenskaya.png" alt="">Таганско-Краснопресненская</label>
            <label><input type="checkbox" value="Калининская" /> <img class="metro-icon" src="metro_icons/kalininskaya.png" alt="">Калининская</label>
            <label><input type="checkbox" value="Солнцевская" /> <img class="metro-icon" src="metro_icons/solncevskaya.png" alt="">Солнцевская</label>
            <label><input type="checkbox" value="Серпуховско-Тимирязевская" /> <img class="metro-icon" src="metro_icons/serpuhovsko-timiryazevskaya.png" alt="">Серпуховско-Тимирязевская</label>
            <label><input type="checkbox" value="Люблинско-Дмитровская" /> <img class="metro-icon" src="metro_icons/lyublinsko-dmitrovskaya.png" alt="">Люблинско-Дмитровская</label>
            <label><input type="checkbox" value="Большая кольцевая" /> <img class="metro-icon" src="metro_icons/bolshaya-kolcevaya.png" alt="">Большая кольцевая</label>
            <label><input type="checkbox" value="Бутовская" /> <img class="metro-icon" src="metro_icons/butovskaya.png" alt="">Бутовская</label>
            <label><input type="checkbox" value="Московское центральное кольцо" /> <img class="metro-icon" src="metro_icons/mck.png" alt="">Московское центральное кольцо</label>
            <label><input type="checkbox" value="Некрасовская" /> <img class="metro-icon" src="metro_icons/nekrasovskaya.png" alt="">Некрасовская</label>
            <label><input type="checkbox" value="Троицкая" /> <img class="metro-icon" src="metro_icons/troickaya.png" alt="">Троицкая</label>
            <label><input type="checkbox" value="Рублёво-Архангельская" /> <img class="metro-icon" src="metro_icons/rublovo-arhangelskaya.png" alt="">Рублёво-Архангельская</label>
            <label><input type="checkbox" value="Бирюлёвская" /> <img class="metro-icon" src="metro_icons/biryulevskaya.png" alt="">Бирюлёвская</label>
            <label><input type="checkbox" value="МЦД1" /> <img class="metro-icon" src="metro_icons/mcd1.png" alt="">МЦД1</label>
            <label><input type="checkbox" value="МЦД2" /> <img class="metro-icon" src="metro_icons/mcd2.png" alt="">МЦД2</label>
            <label><input type="checkbox" value="МЦД3" /> <img class="metro-icon" src="metro_icons/mcd3.png" alt="">МЦД3</label>
            <label><input type="checkbox" value="МЦД4" /> <img class="metro-icon" src="metro_icons/mcd4.png" alt="">МЦД4</label>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" id="saveBtn">Сохранить</button>
          <button class="btn-secondary" id="resetBtn">Сбросить</button>
        </div>
      </div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      document.getElementById('resetBtn').addEventListener('click', () => {
        document.querySelector('input[name="type"][value="any"]').checked = true;
        document.getElementById('price_min').value = '';
        document.getElementById('price_max').value = '';
        document.querySelectorAll('input[name="ring"]').forEach(i => i.checked = false);
        document.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
      });

      document.getElementById('saveBtn').addEventListener('click', () => {
        // Блокируем сохранение при логической ошибке цены
        if (!isPriceRangeValid()) {
          alert('Проверьте поля цены: "До" не может быть меньше "От"');
          return;
        }
        const payload = collectPayload();
        console.log('Filters payload:', payload);
        try {
          if (tg?.sendData) {
            tg.sendData(JSON.stringify(payload));
          }
        } catch (e) {
          console.error('sendData error', e);
        }
        if (tg) tg.close();
      });

      // Валидация цен: запрещаем 0/отрицательные и подсвечиваем логическую ошибку (от > до)
      const priceMinEl = document.getElementById('price_min');
      const priceMaxEl = document.getElementById('price_max');

      function clampPositive(el) {
        const v = parseInt(el.value, 10);
        if (isNaN(v) || v <= 0) {
          el.classList.add('input-error');
        } else {
          el.classList.remove('input-error');
        }
      }

      function validateRange() {
        const vMin = parseInt(priceMinEl.value, 10);
        const vMax = parseInt(priceMaxEl.value, 10);
        // убираем прошлую подсветку
        priceMinEl.classList.remove('input-error');
        priceMaxEl.classList.remove('input-error');
        // если введены оба и логика нарушена — подсветить оба
        if (!isNaN(vMin) && !isNaN(vMax) && vMax < vMin) {
          priceMinEl.classList.add('input-error');
          priceMaxEl.classList.add('input-error');
        }
      }

      function isPriceRangeValid() {
        const vMin = parseInt(priceMinEl.value, 10);
        const vMax = parseInt(priceMaxEl.value, 10);
        // Пустые поля считаем валидными (нет фильтра) — проверяем только если оба заданы
        if (isNaN(vMin) && isNaN(vMax)) return true;
        if (!isNaN(vMin) && vMin <= 0) return false;
        if (!isNaN(vMax) && vMax <= 0) return false;
        if (!isNaN(vMin) && !isNaN(vMax) && vMax < vMin) return false;
        return true;
      }

      function cleanupOnBlur(el) {
        const v = parseInt(el.value, 10);
        if (isNaN(v) || v <= 0) {
          el.value = '';
          el.classList.remove('input-error');
        }
      }

      priceMinEl.addEventListener('input', () => { clampPositive(priceMinEl); validateRange(); });
      priceMaxEl.addEventListener('input', () => { clampPositive(priceMaxEl); validateRange(); });
      priceMinEl.addEventListener('blur', () => { cleanupOnBlur(priceMinEl); validateRange(); });
      priceMaxEl.addEventListener('blur', () => { cleanupOnBlur(priceMaxEl); validateRange(); });

      function collectPayload() {
        const payload = {};
        const type = document.querySelector('input[name="type"]:checked')?.value || 'Любое';
        payload.type = type;

        const vMin = parseInt(document.getElementById('price_min').value, 10);
        const vMax = parseInt(document.getElementById('price_max').value, 10);
        if (!isNaN(vMin) && vMin > 0) payload.price_min = vMin;
        if (!isNaN(vMax) && vMax > 0) payload.price_max = vMax;

        const rings = Array.from(document.querySelectorAll('input[name="ring"]:checked')).map(i => {
          if (i.value === 'inside') return 'Внутри кольца';
          const n = parseInt(i.value, 10);
          return isNaN(n) ? i.value : n;
        });
        if (rings.length) payload.rings = rings;

        // Метро: только чекбоксы внутри блока со списком метро
        const metros = Array.from(document.querySelectorAll('.checkboxes input[type="checkbox"]:checked')).map(i => i.value);
        if (metros.length) payload.metros = metros;

        return payload;
      }
    </script>
  </body>
  </html>


